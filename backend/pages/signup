import { useState, useEffect } from 'react'
import { useRouter } from 'next/router'

import { useCurrentUser } from '@/hooks'
import LoginWrapper from '@/components/login-wrapper'
import { Email, Name, Password } from '@/components/login-inputs'
import SpinnerButton from '@/components/spinner-button'
import Alert from '@/components/alert'

const SignupPage = () => {
  const router = useRouter()
  const [loading, setLoading] = useState(false)
  const [user, { mutate }] = useCurrentUser()
  const [errorMsg, setErrorMsg] = useState('')
  useEffect(() => {
    if (user) router.push('/')
  }, [user])

  const handleSubmit = async e => {
    e.preventDefault()
    setLoading(true)
    setErrorMsg('')

    const body = {
      email: e.currentTarget.email.value,
      name: e.currentTarget.name.value,
      password: e.currentTarget.password.value
    }
    const res = await fetch('/api/users', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    })
    if (res.status === 201) {
      const userObj = await res.json()
      mutate(userObj)
    } else {
      setErrorMsg(await res.text())
    }
    setLoading(false)
  }

  return (
    <LoginWrapper title="Crie sua conta">
      <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
        <Name />
        <Email />
        <Password />
        <SpinnerButton label="Criar conta" loading={loading} />
        <div className="h-14">
          {errorMsg && <Alert label={errorMsg} className="warning" />}
        </div>
      </form>
    </LoginWrapper>
  )
}

export default SignupPage
